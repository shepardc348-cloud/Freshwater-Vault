<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Freshwater Vault - Client Portal</title>

  <!-- REACT & TAILWIND SETUP (single-file) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif; background: #f8fafc; }
    .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // --- ICONS (Self-Contained) ---
    const IconBase = ({ children, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24"
           fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
           className={className}>
        {children}
      </svg>
    );

    const Icons = {
      Shield: (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></IconBase>,
      MessageSquare: (props) => <IconBase {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></IconBase>,
      FileCheck: (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><path d="m9 15 2 2 4-4" /></IconBase>,
      ChevronRight: (props) => <IconBase {...props}><polyline points="9 18 15 12 9 6" /></IconBase>,
      ArrowRight: (props) => <IconBase {...props}><line x1="5" y1="12" x2="19" y2="12" /><polyline points="12 5 19 12 12 19" /></IconBase>,
      Zap: (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></IconBase>,
      X: (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></IconBase>,
      FileText: (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></IconBase>,
      CheckCircle: (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></IconBase>,
      Send: (props) => <IconBase {...props}><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></IconBase>,
      Search: (props) => <IconBase {...props}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></IconBase>,
      Lock: (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></IconBase>
    };

    const { Shield, MessageSquare, FileCheck, ChevronRight, ArrowRight, Zap, X, FileText, CheckCircle, Send, Search, Lock } = Icons;

    // ---------------------------------------------------------------------
    // AGREEMENT TEXT (Paste your full MSA here)
    // Tip: paste the entire agreement text between the backticks.
    // ---------------------------------------------------------------------
    const AGREEMENT_TEXT = `{{PASTE_YOUR_MASTER_SERVICE_AGREEMENT_TEXT_HERE}}`;

    // ---------------------------------------------------------------------
    // Lightweight local clause finder (FREE mode):
    // - Splits agreement into chunks by headings
    // - Scores chunks by keyword hits
    // ---------------------------------------------------------------------
    function normalize(q){
      return (q || "")
        .toLowerCase()
        .replace(/[^a-z0-9\s]/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function parseAgreement(text){
      const lines = (text || "").split(/\r?\n/);
      const chunks = [];
      let cur = { heading: "INTRODUCTION", text: "" };

      const isHeading = (t) => {
        const s = (t || "").trim();
        if (!s) return false;
        if (/^(ARTICLE|SECTION)\b/i.test(s)) return true;
        if (/^\d+(\.\d+)*\s+/.test(s)) return true;
        if (/^[A-Z0-9][A-Z0-9\s\-:&]{8,70}$/.test(s) && s === s.toUpperCase()) return true;
        return false;
      };

      for (const line of lines){
        const t = line.trim();
        if (isHeading(t)){
          if (cur.text.trim()) chunks.push(cur);
          cur = { heading: t, text: "" };
        } else {
          cur.text += line + "\n";
        }
      }
      if (cur.text.trim()) chunks.push(cur);
      return chunks.length ? chunks : [{ heading: "AGREEMENT", text: text || "" }];
    }

    const CHUNKS = parseAgreement(AGREEMENT_TEXT);

    const SYNONYMS = {
      cancel: ["cancellation","terminate","termination","quit","end","refund","deposit"],
      payment: ["payments","invoice","billing","net","fee","charge"],
      late: ["late","overdue","past","due","interest","finance","charge","apr"],
      liability: ["liability","damage","damages","responsible","responsibility","injury","slip","fall","warranty","warranties"],
      dispute: ["dispute","arbitration","court","lawsuit","sue","venue","jury"],
      snow: ["snow","ice","plow","plowing","trigger","accumulation","storm","berm"],
      scope: ["scope","work","change","order","extras","additional"]
    };

    function expandTokens(question){
      const q = normalize(question);
      const raw = q.split(" ").filter(Boolean);
      const set = new Set(raw);
      for (const [k, arr] of Object.entries(SYNONYMS)){
        for (const w of raw){
          if (w === k || arr.includes(w)){
            set.add(k);
            arr.forEach(x => set.add(x));
          }
        }
      }
      return Array.from(set).filter(t => t.length >= 3).slice(0, 30);
    }

    function bestMatches(question, top=3){
      const tokens = expandTokens(question);
      const scored = CHUNKS.map(c => {
        const hay = (c.heading + "\n" + c.text).toLowerCase();
        let score = 0;
        for (const t of tokens){
          const safe = t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
          const re = new RegExp("\\b" + safe + "\\b", "g");
          const m = hay.match(re);
          if (m) score += m.length;
        }
        return { ...c, score };
      }).filter(x => x.score > 0).sort((a,b) => b.score - a.score);

      return scored.slice(0, top);
    }

    function excerpt(text, limit=900){
      const s = (text || "").trim().replace(/\s+/g, " ");
      return s.length > limit ? s.slice(0, limit) + "…" : s;
    }

    // ---------------------------------------------------------------------
    // AI Explain mode (Protected):
    // Calls Netlify Function -> Gemini using server-side env key.
    // ---------------------------------------------------------------------
    async function callProtectedAI({ question, excerpts }){
      const r = await fetch("/.netlify/functions/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question, excerpts })
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data.error || "AI unavailable");
      return data.answer || "";
    }

    // ---------------------------------------------------------------------
    // APP
    // ---------------------------------------------------------------------
    const App = () => {
      const [view, setView] = useState("landing");
      const [tab, setTab] = useState("dashboard"); // dashboard | chat
      const [mode, setMode] = useState("quick");   // quick | ai
      const [isTyping, setIsTyping] = useState(false);
      const [chatInput, setChatInput] = useState("");
      const [chatHistory, setChatHistory] = useState([
        {
          role: "ai",
          text:
            "Welcome to the Freshwater Vault. Ask about your agreement terms and I’ll show the exact clause. (Informational only — the signed agreement controls.)"
        }
      ]);

      const [showDocViewer, setShowDocViewer] = useState(false);
      const [docSearch, setDocSearch] = useState("");
      const docTextRef = useRef(null);

      const clientDocs = [
        { id: 1, title: "Master Service Agreement", signed: "2026 Season", type: "Core Contract", status: "active" },
        { id: 2, title: "Residential Snow Addendum", signed: "2026 Season", type: "Service Specific", status: "active" },
        { id: 3, title: "Mowing & Maintenance Addendum", signed: "2026 Season", type: "Service Specific", status: "active" }
      ];

      const enter = () => setView("dashboard");

      const pushAI = (text) => setChatHistory(prev => [...prev, { role: "ai", text }]);
      const pushUser = (text) => setChatHistory(prev => [...prev, { role: "user", text }]);

      const handleChat = async () => {
        const q = chatInput.trim();
        if (!q) return;

        pushUser(q);
        setChatInput("");
        setIsTyping(true);

        const hits = bestMatches(q, 3);

        if (!hits.length) {
          pushAI("I couldn’t locate that in the agreement text I have loaded. Try keywords like: cancellation, late fee, liability, arbitration, scope.");
          setIsTyping(false);
          return;
        }

        // Quick mode: show excerpt + source
        if (mode === "quick") {
          const best = hits[0];
          pushAI(
            `Here you go.\n\nSOURCE: ${best.heading}\n\n“${excerpt(best.text)}”\n\n(Informational only — the signed agreement controls.)`
          );
          setIsTyping(false);
          return;
        }

        // AI mode: call protected function with top excerpts
        try {
          const answer = await callProtectedAI({
            question: q,
            excerpts: hits.map(h => ({ heading: h.heading, text: excerpt(h.text, 1200) }))
          });

          pushAI(answer);
        } catch (e) {
          pushAI("AI Explain is unavailable right now. Use Quick mode or contact Freshwater support.");
        } finally {
          setIsTyping(false);
        }
      };

      const highlightDoc = (text, query) => {
        if (!query) return text;
        const safe = query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        const re = new RegExp(`(${safe})`, "gi");
        return text.replace(re, "««$1»»");
      };

      const renderHighlighted = (raw) => {
        // convert our marker tokens to <mark>
        const escaped = raw
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");

        return escaped
          .replace(/««/g, '<mark class="bg-blue-200 text-slate-900 px-1 rounded">')
          .replace(/»»/g, "</mark>");
      };

      // Auto-scroll chat to bottom
      const chatEndRef = useRef(null);
      useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatHistory, isTyping]);

      if (view === "landing") {
        return (
          <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6 text-white font-sans">
            <div className="max-w-md w-full space-y-8 text-center">
              <div className="flex justify-center">
                <div className="bg-blue-600 p-6 rounded-3xl shadow-2xl shadow-blue-500/20 ring-4 ring-blue-500/20">
                  <Shield size={56} />
                </div>
              </div>
              <div className="space-y-2">
                <h1 className="text-4xl font-black tracking-tight">Freshwater <span className="text-blue-400">Vault</span></h1>
                <p className="text-slate-400 text-lg">Document Portal + Clause Lookup</p>
              </div>

              <div className="bg-slate-800/50 backdrop-blur-sm p-8 rounded-2xl border border-slate-700/50 shadow-xl space-y-4">
                <div className="text-sm text-slate-300 leading-relaxed">
                  View your agreements and ask questions to locate the exact clause.
                </div>

                <button
                  onClick={enter}
                  className="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold transition flex items-center justify-center gap-2"
                >
                  Enter Portal <ArrowRight size={20} />
                </button>

                <div className="flex items-center justify-center gap-2 text-[11px] text-slate-500">
                  <Lock size={14} />
                  <span>AI Explain uses a protected server key (no API key in your browser).</span>
                </div>
              </div>

              <p className="text-[10px] text-slate-600 uppercase tracking-widest">Secure • Fast • Client-First</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
          <nav className="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
            <div className="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
              <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView("landing")}>
                <div className="bg-blue-600 p-2 rounded-lg"><Shield className="text-white" size={20} /></div>
                <span className="font-black text-xl tracking-tight">FRESHWATER <span className="text-blue-600">VAULT</span></span>
              </div>

              <div className="flex gap-2">
                <button
                  onClick={() => setTab("dashboard")}
                  className={`px-4 py-2 rounded-lg font-semibold text-sm transition ${tab === "dashboard" ? "bg-blue-50 text-blue-600" : "text-slate-600 hover:bg-slate-100"}`}
                >
                  Documents
                </button>
                <button
                  onClick={() => setTab("chat")}
                  className={`px-4 py-2 rounded-lg font-semibold text-sm transition flex items-center gap-2 ${tab === "chat" ? "bg-blue-50 text-blue-600" : "text-slate-600 hover:bg-slate-100"}`}
                >
                  <MessageSquare size={16} /> Ask
                </button>
              </div>
            </div>
          </nav>

          <main className="max-w-6xl mx-auto p-6">
            {tab === "dashboard" ? (
              <div className="space-y-8">
                <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-2xl p-6 shadow-lg">
                  <h2 className="text-2xl font-bold mb-1">Welcome to your Portal</h2>
                  <div className="flex flex-col gap-2 text-blue-100 text-sm mt-3">
                    <div className="flex items-center gap-2"><CheckCircle size={14} /> <span>Status: Active</span></div>
                    <div className="text-xs text-blue-100/90">Informational only — the signed agreement controls.</div>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {clientDocs.map(doc => (
                    <div
                      key={doc.id}
                      onClick={() => setShowDocViewer(true)}
                      className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md hover:border-blue-300 transition cursor-pointer group"
                    >
                      <div className="flex items-start justify-between mb-4">
                        <div className="bg-blue-50 p-3 rounded-xl text-blue-600"><FileCheck size={24} /></div>
                        <span className="text-xs px-2 py-1 bg-green-50 text-green-700 rounded-full font-medium">Active</span>
                      </div>
                      <h3 className="font-bold text-lg mb-1">{doc.title}</h3>
                      <p className="text-xs text-slate-500 mb-3">{doc.type}</p>
                      <div className="flex items-center justify-between text-xs text-slate-400">
                        <span>Season: {doc.signed}</span>
                        <ChevronRight className="text-slate-300 group-hover:text-blue-500" size={16} />
                      </div>
                    </div>
                  ))}
                </div>

                <div className="bg-white rounded-3xl p-8 border border-slate-200 relative overflow-hidden shadow-sm">
                  <div className="relative z-10 max-w-xl">
                    <div className="flex items-center gap-2 mb-3 text-blue-600">
                      <Zap size={24} />
                      <span className="text-xs font-bold uppercase tracking-wider">Clause Finder</span>
                    </div>
                    <h3 className="text-2xl font-bold mb-3">Ask and get the exact clause.</h3>
                    <p className="text-slate-500 mb-6 leading-relaxed">
                      Quick mode is free (local search). AI Explain gives a plain-English answer and cites the clause using a protected server key.
                    </p>
                    <button onClick={() => setTab("chat")} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-slate-800 transition flex items-center gap-2">
                      Open Assistant <ArrowRight size={18} />
                    </button>
                  </div>
                </div>
              </div>
            ) : (
              <div className="bg-white rounded-2xl shadow-lg border border-slate-200 h-[72vh] flex flex-col overflow-hidden">
                <div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                  <div className="flex items-center gap-3">
                    <div className="bg-blue-100 p-2 rounded-lg text-blue-600"><Zap size={20} /></div>
                    <div>
                      <h3 className="font-bold text-sm">Contract Assistant</h3>
                      <p className="text-xs text-slate-500">Find clauses + explain terms (informational only)</p>
                    </div>
                  </div>

                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => setMode("quick")}
                      className={`px-3 py-2 rounded-lg text-xs font-bold transition ${mode === "quick" ? "bg-blue-600 text-white" : "bg-white border border-slate-200 text-slate-600 hover:bg-slate-100"}`}
                      title="Free: local clause search"
                    >
                      Quick
                    </button>
                    <button
                      onClick={() => setMode("ai")}
                      className={`px-3 py-2 rounded-lg text-xs font-bold transition ${mode === "ai" ? "bg-blue-600 text-white" : "bg-white border border-slate-200 text-slate-600 hover:bg-slate-100"}`}
                      title="Uses protected server key"
                    >
                      AI Explain
                    </button>
                  </div>
                </div>

                <div className="flex-1 overflow-y-auto p-6 space-y-4 no-scrollbar">
                  {chatHistory.map((msg, i) => (
                    <div key={i} className={`flex ${msg.role === "user" ? "justify-end" : "justify-start"}`}>
                      <div className={`max-w-[86%] p-4 rounded-2xl text-sm whitespace-pre-wrap ${msg.role === "user" ? "bg-blue-600 text-white rounded-tr-none" : "bg-slate-100 text-slate-800 rounded-tl-none"}`}>
                        {msg.text}
                      </div>
                    </div>
                  ))}
                  {isTyping && <div className="text-xs text-slate-400 ml-2 animate-pulse">Analyzing agreement…</div>}
                  <div ref={chatEndRef} />
                </div>

                <div className="p-4 border-t border-slate-100 flex gap-2">
                  <input
                    type="text"
                    value={chatInput}
                    onChange={(e) => setChatInput(e.target.value)}
                    onKeyDown={(e) => (e.key === "Enter" ? handleChat() : null)}
                    placeholder='Example: "If I cancel mid-season, what do I owe?"'
                    className="flex-1 bg-slate-50 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500"
                  />
                  <button onClick={handleChat} className="bg-blue-600 text-white p-3 rounded-xl hover:bg-blue-700" title="Ask">
                    <Send size={20} />
                  </button>
                </div>

                <div className="px-4 pb-4 text-[11px] text-slate-500">
                  <span className="font-bold">Note:</span> Quick mode is free. AI Explain uses a server function (no API key exposed in your browser).
                </div>
              </div>
            )}
          </main>

          {showDocViewer && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[92vh] flex flex-col overflow-hidden">
                <div className="flex justify-between items-center p-6 border-b border-slate-200">
                  <div className="flex items-center gap-3">
                    <FileText className="text-blue-600" size={24} />
                    <h2 className="font-bold">Master Service Agreement</h2>
                  </div>
                  <button onClick={() => setShowDocViewer(false)} className="p-2 rounded-lg hover:bg-slate-100"><X size={22} /></button>
                </div>

                <div className="p-4 border-b border-slate-200 bg-slate-50">
                  <div className="flex flex-col sm:flex-row gap-2">
                    <div className="flex-1 relative">
                      <input
                        value={docSearch}
                        onChange={(e) => setDocSearch(e.target.value)}
                        placeholder="Search within agreement…"
                        className="w-full bg-white border border-slate-200 pl-10 pr-3 py-2 rounded-xl outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                        <Search size={16} />
                      </div>
                    </div>
                    <button
                      onClick={() => setDocSearch("")}
                      className="px-4 py-2 rounded-xl bg-white border border-slate-200 font-bold text-sm hover:bg-slate-100"
                    >
                      Clear
                    </button>
                  </div>
                </div>

                <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                  <div
                    className="bg-white p-8 shadow-sm border border-slate-200 text-sm whitespace-pre-wrap leading-relaxed"
                    ref={docTextRef}
                    dangerouslySetInnerHTML={{
                      __html: renderHighlighted(highlightDoc(AGREEMENT_TEXT || "Paste your agreement text into AGREEMENT_TEXT in index.html.", docSearch))
                    }}
                  />
                </div>

                <div className="p-4 border-t border-slate-200 flex justify-between items-center">
                  <div className="text-xs text-slate-500">
                    Informational only — the signed agreement controls.
                  </div>
                  <button onClick={() => setShowDocViewer(false)} className="px-6 py-2 bg-blue-600 text-white rounded-lg">Close</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
