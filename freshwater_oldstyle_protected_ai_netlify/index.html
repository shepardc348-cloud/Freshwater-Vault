<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freshwater Agreement Intelligence Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .glow { box-shadow: 0 0 20px rgba(6, 182, 212, 0.3); }
        .excerpt {
            background: rgba(6, 182, 212, 0.1);
            border-left: 3px solid #06b6d4;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
        }
        .topic-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .topic-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(6, 182, 212, 0.4);
        }
        .highlight { background: rgba(6, 182, 212, 0.3); padding: 2px 4px; border-radius: 2px; }
        #agreementModal { display: none; }
        #agreementModal.active { display: flex; }

        .agreement-content h1, .agreement-content h2, .agreement-content h3 {
            color: #06b6d4;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .agreement-content h1 { font-size: 1.5rem; }
        .agreement-content h2 { font-size: 1.25rem; }
        .agreement-content h3 { font-size: 1.1rem; }
        .agreement-content p { margin-bottom: 0.75rem; line-height: 1.7; }
        .agreement-content ul, .agreement-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .agreement-content strong { color: #22d3ee; }
        .agreement-content em { color: #a5f3fc; }

        .loading-spinner {
            border: 3px solid rgba(6, 182, 212, 0.3);
            border-top: 3px solid #06b6d4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body class="text-gray-100">

<div id="vaultEntry" class="min-h-screen flex items-center justify-center p-6">
    <div class="max-w-md w-full space-y-8 text-center">
        <div class="flex justify-center">
            <div class="bg-blue-600 p-6 rounded-3xl shadow-2xl shadow-blue-500/20 ring-4 ring-blue-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-14 h-14 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3l7 3v5c0 5-3.8 8.7-7 10-3.2-1.3-7-5-7-10V6l7-3z"/></svg>
            </div>
        </div>
        <div class="space-y-2">
            <h1 class="text-5xl font-black tracking-tight">Freshwater <span class="text-blue-400">Vault</span></h1>
            <p class="text-slate-400 text-2xl">Document Portal + Clause Lookup</p>
        </div>
        <div class="glass p-8 rounded-2xl border border-slate-700/50 shadow-xl space-y-5">
            <p class="text-slate-300">View your agreements and ask questions to locate the exact clause.</p>
            <button onclick="enterPortal()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold text-xl transition">Enter Portal ‚Üí</button>
            <p class="text-xs text-slate-500">üîí AI Explain uses a protected server key (no API key in your browser).</p>
        </div>
        <p class="text-[10px] text-slate-600 uppercase tracking-[0.2em]">Secure ‚Ä¢ Fast ‚Ä¢ Client-First</p>
    </div>
</div>

<div id="portalApp" class="hidden">
<header class="glass sticky top-0 z-50 border-b border-cyan-500/20">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-emerald-500 rounded-lg flex items-center justify-center font-bold text-slate-900">
                FL
            </div>
            <div>
                <h1 class="text-xl font-bold">Agreement Intelligence Portal</h1>
                <p class="text-xs text-gray-400" id="docStatus">Loading agreement...</p>
            </div>
        </div>
        <a href="tel:6129998067" class="text-cyan-400 hover:text-cyan-300 transition text-sm">
            üìû 612-999-8067
        </a>
    </div>
</header>

<section class="max-w-7xl mx-auto px-6 py-12 text-center">
    <h2 class="text-4xl md:text-5xl font-black mb-4 bg-gradient-to-r from-cyan-400 to-emerald-400 bg-clip-text text-transparent">
        Ask questions. Get the exact clause.
    </h2>
    <p class="text-gray-400 max-w-2xl mx-auto mb-8">
        This tool searches your live agreement and replies in plain English with the most relevant excerpt.
        It does not invent terms and does not replace the signed agreement.
    </p>
    <div class="flex gap-4 justify-center flex-wrap">
        <button onclick="openAgreement()" class="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 rounded-lg font-semibold transition glow">
            üìÑ Open Agreement
        </button>
        <button onclick="focusChat()" class="px-6 py-3 glass hover:bg-slate-700 rounded-lg font-semibold transition">
            üí¨ Ask a Question
        </button>
    </div>
</section>

<div class="max-w-7xl mx-auto px-6 pb-12 grid md:grid-cols-3 gap-6">
    <div class="md:col-span-2 glass rounded-2xl p-6 space-y-4">
        <div class="flex justify-between items-center">
            <h3 class="text-xl font-bold">üí¨ Ask Assistant</h3>
            <div class="flex gap-2 text-xs">
                <button id="modeQuick" onclick="setMode('quick')" class="px-3 py-1 bg-cyan-600 rounded-full">Quick Answer</button>
                <button id="modeAI" onclick="setMode('ai')" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-full transition">AI Explain</button>
            </div>
        </div>

        <div id="chatBox" class="space-y-3 max-h-96 overflow-y-auto pr-2">
            <div class="glass rounded-lg p-4">
                <p class="text-sm text-gray-300">üëã Hi! I'm your agreement assistant. Ask me about cancellation, payments, liability, snow triggers, or any clause.</p>
            </div>
        </div>

        <div class="flex gap-2">
            <input
                id="questionInput"
                type="text"
                placeholder="e.g., What's the cancellation policy?"
                class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 text-white"
                onkeypress="if(event.key==='Enter') askQuestion()"
            />
            <button onclick="askQuestion()" class="px-6 py-3 bg-gradient-to-r from-cyan-600 to-emerald-600 hover:from-cyan-500 hover:to-emerald-500 rounded-lg font-semibold transition glow">
                Send
            </button>
        </div>

        <p class="text-xs text-gray-500 text-center">
            ‚öñÔ∏è Informational only. Not legal advice. The signed agreement controls.
        </p>
    </div>

    <div class="space-y-4">
        <h3 class="text-lg font-bold mb-4">üî• Popular Topics</h3>

        <div onclick="askTopic('cancellation')" class="topic-card glass rounded-xl p-4">
            <div class="text-2xl mb-2">üö´</div>
            <h4 class="font-semibold">Cancellation</h4>
            <p class="text-xs text-gray-400">Refund policy & timing</p>
        </div>

        <div onclick="askTopic('payments')" class="topic-card glass rounded-xl p-4">
            <div class="text-2xl mb-2">üí∞</div>
            <h4 class="font-semibold">Payments</h4>
            <p class="text-xs text-gray-400">Late fees & billing</p>
        </div>

        <div onclick="askTopic('liability')" class="topic-card glass rounded-xl p-4">
            <div class="text-2xl mb-2">‚ö†Ô∏è</div>
            <h4 class="font-semibold">Liability</h4>
            <p class="text-xs text-gray-400">Damage & responsibility</p>
        </div>

        <div onclick="askTopic('snow triggers')" class="topic-card glass rounded-xl p-4">
            <div class="text-2xl mb-2">‚ùÑÔ∏è</div>
            <h4 class="font-semibold">Snow Triggers</h4>
            <p class="text-xs text-gray-400">When service starts</p>
        </div>

        <div onclick="askTopic('arbitration')" class="topic-card glass rounded-xl p-4">
            <div class="text-2xl mb-2">‚öñÔ∏è</div>
            <h4 class="font-semibold">Dispute Resolution</h4>
            <p class="text-xs text-gray-400">Arbitration process</p>
        </div>
    </div>
</div>

<div id="agreementModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 items-center justify-center p-6">
    <div class="glass rounded-2xl max-w-4xl w-full max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center p-6 border-b border-slate-700">
            <div>
                <h3 class="text-xl font-bold">üìÑ Master Service Agreement</h3>
                <p class="text-xs text-gray-400" id="modalDocStatus">Full contract document</p>
            </div>
            <button onclick="closeAgreement()" class="text-gray-400 hover:text-white text-2xl">√ó</button>
        </div>

        <div class="p-6 border-b border-slate-700">
            <input
                id="searchInput"
                type="text"
                placeholder="Search agreement..."
                class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                oninput="searchAgreement()"
            />
        </div>

        <div id="agreementContent" class="agreement-content flex-1 overflow-y-auto p-6 text-sm leading-relaxed">
            <div class="flex items-center justify-center py-12">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div class="p-6 border-t border-slate-700 flex justify-between">
            <a href="https://docs.google.com/document/d/1lRhOh_Ji2jWlI7BUEo32GGskDAqFEmQp/export?format=pdf" target="_blank" class="px-4 py-2 glass hover:bg-slate-700 rounded-lg transition">
                üì• Download PDF
            </a>
            <button onclick="closeAgreement()" class="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg font-semibold transition">
                Close
            </button>
        </div>
    </div>
</div>
</div>

<script>
const GOOGLE_DOC_ID = '1lRhOh_Ji2jWlI7BUEo32GGskDAqFEmQp';
let AGREEMENT_TEXT = '';
let AGREEMENT_HTML = '';
let sections = [];

function enterPortal() {
    document.getElementById('vaultEntry')?.classList.add('hidden');
    document.getElementById('portalApp')?.classList.remove('hidden');
    loadAgreementFromGoogleDocs();
}

async function loadAgreementFromGoogleDocs() {
    const statusEl = document.getElementById('docStatus');
    const modalStatusEl = document.getElementById('modalDocStatus');

    try {
        statusEl.textContent = 'üîÑ Fetching latest agreement...';
        const response = await fetch(`https://docs.google.com/document/d/${GOOGLE_DOC_ID}/export?format=html`, { mode: 'cors' });
        if (!response.ok) {
            throw new Error('Failed to fetch document');
        }
        AGREEMENT_HTML = await response.text();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = AGREEMENT_HTML;
        AGREEMENT_TEXT = tempDiv.textContent || tempDiv.innerText || '';
        sections = parseAgreement();
        localStorage.setItem('agreement_html', AGREEMENT_HTML);
        localStorage.setItem('agreement_text', AGREEMENT_TEXT);
        localStorage.setItem('agreement_updated', new Date().toISOString());
        const updateTime = new Date().toLocaleTimeString();
        statusEl.textContent = `‚úÖ Updated ${updateTime}`;
        if (modalStatusEl) {
            modalStatusEl.textContent = `Last updated: ${updateTime}`;
        }
        return true;
    } catch (error) {
        console.warn('Could not fetch live agreement, using cache:', error);
        const cachedHTML = localStorage.getItem('agreement_html');
        const cachedText = localStorage.getItem('agreement_text');
        const cachedTime = localStorage.getItem('agreement_updated');
        if (cachedHTML && cachedText) {
            AGREEMENT_HTML = cachedHTML;
            AGREEMENT_TEXT = cachedText;
            sections = parseAgreement();
            const cacheDate = new Date(cachedTime).toLocaleDateString();
            statusEl.textContent = `üì¶ Cached version (${cacheDate})`;
            if (modalStatusEl) {
                modalStatusEl.textContent = `Cached from: ${cacheDate}`;
            }
        } else {
            statusEl.textContent = '‚ùå Agreement unavailable';
            if (modalStatusEl) {
                modalStatusEl.textContent = 'Could not load agreement';
            }
        }
    }
}

let currentMode = 'quick';

function parseAgreement() {
    const lines = AGREEMENT_TEXT.split('\n');
    const sections = [];
    let currentSection = { heading: 'Introduction', text: '' };

    lines.forEach(line => {
        const trimmed = line.trim();
        if (
            trimmed.startsWith('ARTICLE') ||
            trimmed.startsWith('SECTION') ||
            /^[A-Z\s]{10,60}$/.test(trimmed) ||
            /^[0-9]+\./.test(trimmed) ||
            /^[A-Z]-[0-9]+\./.test(trimmed)
        ) {
            if (currentSection.text.trim()) {
                sections.push(currentSection);
            }
            currentSection = { heading: trimmed, text: '' };
        } else {
            currentSection.text += line + '\n';
        }
    });

    if (currentSection.text.trim()) {
        sections.push(currentSection);
    }
    return sections;
}

const synonyms = {
    'cancel': ['quit', 'terminate', 'end', 'stop', 'exit', 'cancellation'],
    'payment': ['pay', 'fee', 'cost', 'charge', 'billing', 'invoice'],
    'late': ['overdue', 'past due', 'interest', 'finance charge'],
    'liability': ['damage', 'responsible', 'fault', 'injury', 'harm'],
    'sue': ['dispute', 'arbitration', 'legal', 'court', 'lawsuit'],
    'snow': ['plowing', 'winter', 'ice', 'trigger', 'accumulation'],
    'warranty': ['guarantee', 'coverage', 'protection'],
    'scope': ['work', 'services', 'project'],
    'change': ['modification', 'amendment', 'adjustment', 'change order']
};

function expandKeywords(question) {
    const words = question.toLowerCase().split(/\s+/);
    const expanded = new Set(words);
    words.forEach(word => {
        Object.entries(synonyms).forEach(([key, values]) => {
            if (word.includes(key) || values.some(v => word.includes(v))) {
                expanded.add(key);
                values.forEach(v => expanded.add(v));
            }
        });
    });
    return Array.from(expanded);
}

function searchSections(question) {
    const keywords = expandKeywords(question);
    const scored = sections.map(section => {
        const text = (section.heading + ' ' + section.text).toLowerCase();
        const score = keywords.reduce((sum, kw) => {
            const matches = (text.match(new RegExp(kw, 'gi')) || []).length;
            return sum + matches;
        }, 0);
        return { ...section, score };
    }).filter(s => s.score > 0).sort((a, b) => b.score - a.score);
    return scored.slice(0, 3);
}

async function askQuestion() {
    const input = document.getElementById('questionInput');
    const question = input.value.trim();
    if (!question) return;

    addMessage(question, 'user');
    input.value = '';

    if (currentMode === 'quick') {
        quickAnswer(question);
    } else {
        await aiAnswer(question);
    }
}

function quickAnswer(question) {
    const matches = searchSections(question);
    if (matches.length === 0) {
        addMessage("I couldn't find a specific answer. Try keywords like: cancellation, payment, liability, snow, warranty, or arbitration.", 'assistant');
        return;
    }

    const best = matches[0];
    const excerpt = best.text.trim().substring(0, 800) + (best.text.length > 800 ? '...' : '');

    const response = `
        <p class="mb-2">Here's what I found in your agreement:</p>
        <div class="excerpt text-sm">
            <strong>Source:</strong> ${best.heading}<br><br>
            ${excerpt.replace(/\n/g, '<br>')}
        </div>
        <button onclick="openAgreementTo('${best.heading.replace(/'/g, "\\'")}')" class="mt-2 px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-sm transition">
            üìÑ Open in Agreement Viewer
        </button>
    `;

    addMessage(response, 'assistant');
}

async function aiAnswer(question) {
    const matches = searchSections(question);
    if (matches.length === 0) {
        addMessage("I couldn't find relevant sections to explain. Try keywords like: cancellation, payment, liability, snow.", 'assistant');
        return;
    }

    addMessage('ü§ñ AI is analyzing your agreement...', 'assistant', 'thinking');

    try {
        const response = await fetch('/.netlify/functions/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                question: question,
                excerpts: matches.map(m => ({ heading: m.heading, text: m.text.substring(0, 1000) }))
            })
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error || 'AI service unavailable');
        }

        removeThinking();
        addMessage(`
            <p class="mb-2">${data.answer.replace(/\n/g, '<br>')}</p>
            <p class="text-xs text-gray-500 mt-2">Source: ${matches[0].heading}</p>
        `, 'assistant');

    } catch (error) {
        removeThinking();
        addMessage(`‚ö†Ô∏è ${error.message}. Try "Quick Answer" mode or contact 612-999-8067.`, 'assistant');
    }
}

function addMessage(text, role, id = null) {
    const chatBox = document.getElementById('chatBox');
    const div = document.createElement('div');
    if (id) div.id = id;
    div.className = role === 'user'
        ? 'bg-cyan-600 rounded-lg p-3 ml-auto max-w-[80%] text-sm'
        : 'glass rounded-lg p-4 text-sm';
    div.innerHTML = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function removeThinking() {
    const thinking = document.getElementById('thinking');
    if (thinking) thinking.remove();
}

function setMode(mode) {
    currentMode = mode;
    document.getElementById('modeQuick').className = mode === 'quick'
        ? 'px-3 py-1 bg-cyan-600 rounded-full'
        : 'px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-full transition';
    document.getElementById('modeAI').className = mode === 'ai'
        ? 'px-3 py-1 bg-cyan-600 rounded-full'
        : 'px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-full transition';
}

function askTopic(topic) {
    document.getElementById('questionInput').value = `What does the agreement say about ${topic}?`;
    askQuestion();
}

function focusChat() {
    document.getElementById('questionInput').focus();
}

function openAgreement() {
    const modal = document.getElementById('agreementModal');
    const content = document.getElementById('agreementContent');
    if (AGREEMENT_HTML) {
        content.innerHTML = AGREEMENT_HTML;
    } else {
        content.innerHTML = '<p class="text-center text-gray-400">Loading agreement...</p>';
    }
    modal.classList.add('active');
}

function closeAgreement() {
    document.getElementById('agreementModal').classList.remove('active');
}

function openAgreementTo(heading) {
    openAgreement();
    setTimeout(() => {
        const content = document.getElementById('agreementContent');
        const allText = content.textContent;
        const index = allText.indexOf(heading);

        if (index !== -1) {
            const walker = document.createTreeWalker(content, NodeFilter.SHOW_TEXT);
            let found = false;

            while (walker.nextNode() && !found) {
                const node = walker.currentNode;
                if (node.textContent.includes(heading)) {
                    const span = document.createElement('span');
                    span.className = 'highlight';
                    span.textContent = heading;

                    const parent = node.parentNode;
                    const parts = node.textContent.split(heading);

                    parent.insertBefore(document.createTextNode(parts[0]), node);
                    parent.insertBefore(span, node);
                    parent.insertBefore(document.createTextNode(parts[1]), node);
                    parent.removeChild(node);

                    span.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    found = true;
                }
            }
        }
    }, 200);
}

function searchAgreement() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const content = document.getElementById('agreementContent');

    if (!query) {
        content.innerHTML = AGREEMENT_HTML;
        return;
    }

    const regex = new RegExp(`(${query})`, 'gi');
    const temp = document.createElement('div');
    temp.innerHTML = AGREEMENT_HTML;
    const walker = document.createTreeWalker(temp, NodeFilter.SHOW_TEXT);
    const matches = [];

    while (walker.nextNode()) {
        const node = walker.currentNode;
        if (node.textContent.toLowerCase().includes(query)) {
            matches.push(node);
        }
    }

    matches.forEach(node => {
        const span = document.createElement('span');
        const highlighted = node.textContent.replace(regex, '<span class="highlight">$1</span>');
        span.innerHTML = highlighted;
        node.parentNode.replaceChild(span, node);
    });

    content.innerHTML = temp.innerHTML;
    const firstMatch = content.querySelector('.highlight');
    if (firstMatch) {
        firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}
</script>

</body>
</html>
