<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Freshwater Landscaping - Client Portal</title>
  <meta name="description" content="Freshwater Landscaping client portal — secure agreement access and document management." />
  <meta name="theme-color" content="#000000" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="public/assets/icons/icon-192.png" />

  <!-- Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            fw: {
              blue: '#0180d9',
              blueLight: '#a7e3f5',
              blueDark: '#006bb3',
              green: '#81c31c',
              greenDark: '#6fae1b',
              black: '#000000',
              dark: '#111111',
              border: '#333333',
            }
          },
          fontFamily: { sans: ["'Segoe UI'", 'Arial', 'sans-serif'] },
          animation: {
            'fade-in': 'fadeIn 0.4s ease-out',
            'slide-up': 'slideUp 0.3s ease-out',
            'scale-in': 'scaleIn 0.25s ease-out',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { opacity: '0', transform: 'translateY(12px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            scaleIn: { '0%': { opacity: '0', transform: 'scale(0.97)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
          }
        }
      }
    };
  </script>

  <link rel="stylesheet" href="src/css/main.css" />
  <link rel="stylesheet" href="src/css/themes.css" />

  <style>
    /* Core styles — matched to freshwaterlandscaping.com */
    body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #000; color: #fff; line-height: 1.6; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Premium card hover glow */
    .fw-card { background: rgba(10,10,10,0.9); border: 1px solid #222; border-radius: 12px; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
    .fw-card:hover { border-color: #0180d9; box-shadow: 0 0 20px rgba(1,128,217,0.08); }

    /* Subtle blue top-line accent on hero */
    .fw-hero { position: relative; overflow: hidden; }
    .fw-hero::before { content: ''; position: absolute; top: 0; left: 10%; right: 10%; height: 2px; background: linear-gradient(90deg, transparent, #0180d9, transparent); border-radius: 2px; }

    /* Status badge pulse for "Ready" */
    .fw-status-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #81c31c; margin-right: 6px; animation: statusPulse 2.5s ease-in-out infinite; }
    @keyframes statusPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* Smooth button press */
    .fw-btn { transition: all 0.2s ease; }
    .fw-btn:active { transform: scale(0.97); }

    /* Google Docs HTML formatting — preserves highlights, tables, layout */
    .gdoc-content { font-family: 'Segoe UI', Arial, sans-serif; color: #1a1a1a; }
    .gdoc-content p { margin: 0.3em 0; }
    .gdoc-content table { border-collapse: collapse; width: 100%; margin: 0.8em 0; }
    .gdoc-content td, .gdoc-content th { border: 1px solid #d1d5db; padding: 6px 10px; text-align: left; vertical-align: top; }
    .gdoc-content ul, .gdoc-content ol { padding-left: 1.5em; margin: 0.5em 0; }
    .gdoc-content li { margin: 0.2em 0; }
    .gdoc-content img { max-width: 100%; height: auto; }
    .gdoc-content a { color: #0180d9; }
    .gdoc-content sup { font-size: 0.75em; vertical-align: super; }
    .gdoc-content sub { font-size: 0.75em; vertical-align: sub; }
    .gdoc-content hr { border: none; border-top: 1px solid #e5e7eb; margin: 1em 0; }

    /* Refined scrollbar for doc viewer */
    .fw-scroll::-webkit-scrollbar { width: 6px; }
    .fw-scroll::-webkit-scrollbar-track { background: transparent; }
    .fw-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    .fw-scroll::-webkit-scrollbar-thumb:hover { background: #999; }

    @media print {
      nav, .chat-panel, .no-print { display: none !important; }
      .print-only { display: block !important; }
      body { background: white !important; }
    }
  </style>
</head>

<body>
  <div id="root" role="application" aria-label="Freshwater Vault Client Portal"></div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-2" aria-live="polite"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback, useMemo, createContext, useContext } = React;

    // ─── Context ───────────────────────────────────────────────────
    const ThemeContext = createContext();
    const ToastContext = createContext();

    // ─── Icons ─────────────────────────────────────────────────────
    const I = ({ children, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        {children}
      </svg>
    );

    const Icons = {
      Shield: (p) => <I {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></I>,
      MessageSquare: (p) => <I {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></I>,
      FileCheck: (p) => <I {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></I>,
      ChevronRight: (p) => <I {...p}><polyline points="9 18 15 12 9 6"/></I>,
      ChevronDown: (p) => <I {...p}><polyline points="6 9 12 15 18 9"/></I>,
      ArrowRight: (p) => <I {...p}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></I>,
      Zap: (p) => <I {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></I>,
      X: (p) => <I {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></I>,
      FileText: (p) => <I {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></I>,
      CheckCircle: (p) => <I {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></I>,
      Send: (p) => <I {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></I>,
      Search: (p) => <I {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></I>,
      Lock: (p) => <I {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></I>,
      Sun: (p) => <I {...p}><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></I>,
      Moon: (p) => <I {...p}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></I>,
      Menu: (p) => <I {...p}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></I>,
      BarChart: (p) => <I {...p}><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></I>,
      Printer: (p) => <I {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></I>,
      Download: (p) => <I {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></I>,
      List: (p) => <I {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></I>,
      AlertCircle: (p) => <I {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></I>,
      Clock: (p) => <I {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></I>,
      ExternalLink: (p) => <I {...p}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></I>,
      Keyboard: (p) => <I {...p}><rect x="2" y="4" width="20" height="16" rx="2" ry="2"/><path d="M6 8h.001"/><path d="M10 8h.001"/><path d="M14 8h.001"/><path d="M18 8h.001"/><path d="M8 12h.001"/><path d="M12 12h.001"/><path d="M16 12h.001"/><line x1="7" y1="16" x2="17" y2="16"/></I>,
    };

    const { Shield, MessageSquare, FileCheck, ChevronRight, ChevronDown, ArrowRight, Zap, X,
      FileText, CheckCircle, Send, Search, Lock, Sun, Moon, Menu, BarChart, Printer,
      Download, List, AlertCircle, Clock, ExternalLink, Keyboard } = Icons;

    // ─── Constants ─────────────────────────────────────────────────
    const CACHE_DURATION = 60 * 60 * 1000; // 1 hour

    // ─── Client Types & Access Control ─────────────────────────────
    // PIN codes for gated portals. Change per client for white-glove access.
    // Residential is open (no PIN). Commercial/HOA/Municipal require PIN.
    const ACCESS_PINS = {
      commercial: '2003',
      hoa: '2004',
      municipal: '2005',
    };

    const CLIENT_TYPES = {
      residential: {
        label: 'Residential',
        tagline: 'Your Service Documents',
        welcome: 'Welcome back!',
        gated: false,
      },
      commercial: {
        label: 'Commercial',
        tagline: 'Partner Portal',
        welcome: 'Welcome back!',
        gated: true,
      },
      hoa: {
        label: 'HOA / Townhomes',
        tagline: 'Property Management Portal',
        welcome: 'Welcome back!',
        gated: true,
      },
      municipal: {
        label: 'Municipal / City',
        tagline: 'Municipal Services Portal',
        welcome: 'Welcome back!',
        gated: true,
      },
    };

    // Document registry
    const DOCUMENTS = {
      // ─── Residential ───
      res_msa: {
        id: 'res_msa',
        title: 'Master Service Agreement',
        type: 'Core Contract',
        season: '2026 Season',
        googleDocId: '1lRhOh_Ji2jWlI7BUEo32GGskDAqFEmQp',
        audience: ['residential'],
      },
      res_sub: {
        id: 'res_sub',
        title: 'Subcontractor Agreement',
        type: 'Core Contract',
        season: '2026 Season',
        googleDocId: '1QWl4yVbwopuv18cDf-x6_ky-mnPXNQVX',
        audience: ['residential'],
      },
      // ─── Commercial / HOA / Municipal ───
      com_msa: {
        id: 'com_msa',
        title: 'Master Service Agreement',
        type: 'Core Contract',
        season: '2026 Season',
        googleDocId: '1GoymNxV5Ul3LeuHUqV7DgEvwViSRD7mx',
        audience: ['commercial', 'hoa', 'municipal'],
      },
      com_sub: {
        id: 'com_sub',
        title: 'Subcontractor Agreement',
        type: 'Core Contract',
        season: '2026 Season',
        googleDocId: '1QWl4yVbwopuv18cDf-x6_ky-mnPXNQVX', // UPDATE with commercial sub doc ID when ready
        audience: ['commercial', 'hoa', 'municipal'],
      },
    };

    // Compliance packet links for Municipal (W-9, COI, Secretary of State)
    const COMPLIANCE_PACKET = [
      { name: 'W-9 Form', url: '' },                // ADD LINK
      { name: 'Insurance COI', url: '' },            // ADD LINK
      { name: 'MN Secretary of State Filing', url: '' }, // ADD LINK
    ];

    // ─── Utilities ─────────────────────────────────────────────────
    function sanitize(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function debounce(fn, ms) {
      let t;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    }

    function normalize(q) {
      return (q || '').toLowerCase().replace(/[^a-z0-9\s]/g, ' ').replace(/\s+/g, ' ').trim();
    }

    function generateSessionId() {
      return 'sess_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8);
    }

    // ─── Toast System ──────────────────────────────────────────────
    let toastId = 0;
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toast-container');
      if (!container) return;
      const id = ++toastId;
      const colors = {
        success: 'bg-emerald-500', error: 'bg-red-500',
        info: 'bg-cyan-500', warning: 'bg-amber-500'
      };
      const toast = document.createElement('div');
      toast.id = `toast-${id}`;
      toast.className = `${colors[type] || colors.info} text-white px-4 py-3 rounded-xl shadow-lg text-sm font-medium flex items-center gap-2 animate-slide-down`;
      toast.innerHTML = `<span>${sanitize(message)}</span>`;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        toast.style.transition = 'all 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // ─── Skeleton Loader ───────────────────────────────────────────
    function Skeleton({ className = '', count = 1 }) {
      return Array.from({ length: count }).map((_, i) => (
        <div key={i} className={`skeleton rounded-lg ${className}`} aria-hidden="true" />
      ));
    }

    // ─── Error Boundary ────────────────────────────────────────────
    class ErrorBoundary extends React.Component {
      constructor(props) { super(props); this.state = { hasError: false, error: null }; }
      static getDerivedStateFromError(error) { return { hasError: true, error }; }
      componentDidCatch(error, info) { console.error('ErrorBoundary caught:', error, info); }
      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-black p-6">
              <div className="rounded-xl p-8 max-w-md text-center" style={{background:'rgba(10,10,10,0.95)', border:'1px solid #222', borderRadius:'12px'}}>
                <AlertCircle className="mx-auto text-red-500 mb-4" size={48} />
                <h2 className="text-xl font-bold mb-2 text-white">Something went wrong</h2>
                <p className="text-gray-500 text-sm mb-4">An unexpected error occurred. Please refresh the page.</p>
                <button onClick={() => window.location.reload()} className="fw-btn text-white px-6 py-2 rounded-lg font-semibold transition"
                  style={{background:'#0180d9', borderRadius:'8px'}}>
                  Refresh Page
                </button>
              </div>
            </div>
          );
        }
        return this.props.children;
      }
    }

    // ─── Agreement Engine ──────────────────────────────────────────
    const SYNONYMS = {
      cancel: ['cancellation','terminate','termination','quit','end','refund','deposit'],
      payment: ['payments','invoice','billing','net','fee','charge','cost','price'],
      late: ['late','overdue','past','due','interest','finance','charge','apr','penalty'],
      liability: ['liability','damage','damages','responsible','responsibility','injury','slip','fall','warranty','warranties','indemnif'],
      dispute: ['dispute','arbitration','court','lawsuit','sue','venue','jury','mediation'],
      snow: ['snow','ice','plow','plowing','trigger','accumulation','storm','berm','salt','deice'],
      scope: ['scope','work','change','order','extras','additional','addendum'],
      mowing: ['mowing','mow','lawn','grass','turf','cut','trim','edge'],
      season: ['season','term','duration','length','period','year','annual'],
    };

    function parseAgreement(text) {
      const lines = (text || '').split(/\r?\n/);
      const chunks = [];
      let cur = { heading: 'INTRODUCTION', text: '' };
      const isHeading = (t) => {
        const s = (t || '').trim();
        if (!s) return false;
        if (/^(ARTICLE|SECTION)\b/i.test(s)) return true;
        if (/^\d+(\.\d+)*\s+/.test(s)) return true;
        if (/^[A-Z0-9][A-Z0-9\s\-:&]{8,70}$/.test(s) && s === s.toUpperCase()) return true;
        return false;
      };
      for (const line of lines) {
        const t = line.trim();
        if (isHeading(t)) {
          if (cur.text.trim()) chunks.push(cur);
          cur = { heading: t, text: '' };
        } else {
          cur.text += line + '\n';
        }
      }
      if (cur.text.trim()) chunks.push(cur);
      return chunks.length ? chunks : [{ heading: 'AGREEMENT', text: text || '' }];
    }

    function expandTokens(question) {
      const q = normalize(question);
      const raw = q.split(' ').filter(Boolean);
      const set = new Set(raw);
      for (const [k, arr] of Object.entries(SYNONYMS)) {
        for (const w of raw) {
          if (w === k || arr.includes(w)) { set.add(k); arr.forEach(x => set.add(x)); }
        }
      }
      return Array.from(set).filter(t => t.length >= 3).slice(0, 30);
    }

    function bestMatches(agreementText, question, top = 3) {
      const chunks = parseAgreement(agreementText);
      const tokens = expandTokens(question);
      const scored = chunks.map(c => {
        const hay = (c.heading + '\n' + c.text).toLowerCase();
        let score = 0;
        for (const t of tokens) {
          const safe = t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp('\\b' + safe + '\\b', 'g');
          const m = hay.match(re);
          if (m) score += m.length;
        }
        return { ...c, score };
      }).filter(x => x.score > 0).sort((a, b) => b.score - a.score);
      return scored.slice(0, top);
    }

    function excerpt(text, limit = 900) {
      const s = (text || '').trim().replace(/\s+/g, ' ');
      return s.length > limit ? s.slice(0, limit) + '...' : s;
    }

    function buildTOC(html) {
      // Extract headings from HTML content
      const headings = [];
      const re = /<h[1-4][^>]*>([\s\S]*?)<\/h[1-4]>/gi;
      let m;
      while (m = re.exec(html)) {
        const text = m[1].replace(/<[^>]+>/g, '').trim();
        if (text) headings.push({ id: headings.length, heading: text });
      }
      // Fallback: look for bold/uppercase patterns if no headings found
      if (headings.length === 0) {
        const chunks = parseAgreement(html.replace(/<[^>]+>/g, ''));
        return chunks.map((c, i) => ({ id: i, heading: c.heading }));
      }
      return headings;
    }

    // ─── Analytics Tracker ─────────────────────────────────────────
    const analytics = {
      sessionId: null,
      init() {
        this.sessionId = sessionStorage.getItem('fw_session') || generateSessionId();
        sessionStorage.setItem('fw_session', this.sessionId);
        this.track('page_view', { path: window.location.pathname });
      },
      track(event, data = {}) {
        const payload = { event, ...data, sessionId: this.sessionId, timestamp: Date.now() };
        const stored = JSON.parse(localStorage.getItem('fw_analytics') || '[]');
        stored.push(payload);
        if (stored.length > 500) stored.splice(0, stored.length - 500);
        localStorage.setItem('fw_analytics', JSON.stringify(stored));
        // Fire-and-forget to serverless function
        fetch('/.netlify/functions/analytics', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).catch(() => {});
      }
    };

    // ─── Keyboard Shortcuts Modal ──────────────────────────────────
    function ShortcutsModal({ onClose }) {
      const shortcuts = [
        { key: '/', desc: 'Focus search / chat input' },
        { key: 'Esc', desc: 'Close modal or panel' },
        { key: '1', desc: 'Switch to Documents tab' },
        { key: '2', desc: 'Switch to Ask tab' },
        { key: '?', desc: 'Show keyboard shortcuts' },
      ];
      return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in" onClick={onClose} role="dialog" aria-label="Keyboard shortcuts">
          <div className="rounded-xl shadow-2xl max-w-md w-full p-6 animate-scale-in" style={{background:'#0a0a0a', border:'1px solid #222', borderRadius:'12px'}} onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-2">
                <Keyboard size={18} style={{color:'#0180d9'}} />
                <h3 className="font-bold text-base text-white">Keyboard Shortcuts</h3>
              </div>
              <button onClick={onClose} className="p-1 rounded-lg hover:bg-gray-800"><X size={18} className="text-gray-500" /></button>
            </div>
            <div className="space-y-1">
              {shortcuts.map(s => (
                <div key={s.key} className="flex justify-between items-center py-2 px-3 rounded-lg hover:bg-gray-800/50">
                  <span className="text-sm text-gray-400">{s.desc}</span>
                  <kbd className="text-gray-400 px-2 py-1 rounded text-xs font-mono font-bold" style={{background:'rgba(255,255,255,0.05)', border:'1px solid #222'}}>{s.key}</kbd>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ─── Table of Contents Panel ───────────────────────────────────
    function TOCPanel({ toc, onSelect, onClose }) {
      return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-start justify-end animate-fade-in" onClick={onClose}>
          <div className="bg-white h-full w-80 max-w-full shadow-2xl overflow-y-auto fw-scroll" onClick={e => e.stopPropagation()} role="navigation" aria-label="Table of contents">
            <div className="p-4 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white">
              <div className="flex items-center gap-2">
                <List size={18} style={{color:'#0180d9'}} />
                <h3 className="font-bold text-gray-900 text-sm">Table of Contents</h3>
              </div>
              <button onClick={onClose} className="p-1 rounded-lg hover:bg-gray-100"><X size={18} className="text-gray-400" /></button>
            </div>
            <div className="p-2">
              {toc.map((item, i) => (
                <button key={i} onClick={() => { onSelect(item); onClose(); }}
                  className="w-full text-left px-3 py-2 rounded-lg text-sm text-gray-600 hover:bg-blue-50 hover:text-gray-900 transition truncate">
                  {item.heading}
                </button>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ─── Document Viewer Modal ─────────────────────────────────────
    function DocViewer({ agreementText, docTitle = 'Agreement', onClose, isHtml = true }) {
      const [docSearch, setDocSearch] = useState('');
      const [showTOC, setShowTOC] = useState(false);
      const contentRef = useRef(null);
      const toc = useMemo(() => buildTOC(agreementText), [agreementText]);

      // Search highlighting that works inside HTML content
      useEffect(() => {
        if (!contentRef.current || !docSearch || docSearch.length < 2) return;
        // Remove previous highlights
        contentRef.current.querySelectorAll('mark.fw-search-hl').forEach(m => {
          const parent = m.parentNode;
          parent.replaceChild(document.createTextNode(m.textContent), m);
          parent.normalize();
        });
        // Walk text nodes and wrap matches
        const safe = docSearch.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re = new RegExp(safe, 'gi');
        const walker = document.createTreeWalker(contentRef.current, NodeFilter.SHOW_TEXT, null);
        const matches = [];
        let node;
        while (node = walker.nextNode()) {
          if (node.nodeValue.match(re)) matches.push(node);
        }
        matches.forEach(textNode => {
          const frag = document.createDocumentFragment();
          let last = 0;
          textNode.nodeValue.replace(re, (match, offset) => {
            frag.appendChild(document.createTextNode(textNode.nodeValue.slice(last, offset)));
            const mark = document.createElement('mark');
            mark.className = 'fw-search-hl';
            mark.style.cssText = 'background:#06b6d4;color:#fff;padding:1px 3px;border-radius:3px;';
            mark.textContent = match;
            frag.appendChild(mark);
            last = offset + match.length;
          });
          frag.appendChild(document.createTextNode(textNode.nodeValue.slice(last)));
          textNode.parentNode.replaceChild(frag, textNode);
        });
        // Scroll to first match
        const firstMark = contentRef.current.querySelector('mark.fw-search-hl');
        if (firstMark) firstMark.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, [docSearch, agreementText]);

      // Clear highlights when search is emptied
      useEffect(() => {
        if (!docSearch && contentRef.current) {
          contentRef.current.querySelectorAll('mark.fw-search-hl').forEach(m => {
            const parent = m.parentNode;
            parent.replaceChild(document.createTextNode(m.textContent), m);
            parent.normalize();
          });
        }
      }, [docSearch]);

      const handlePrint = () => window.print();

      return (
        <div className="fixed inset-0 bg-black/85 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in" role="dialog" aria-label="Document viewer">
          <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[92vh] flex flex-col overflow-hidden animate-scale-in" style={{borderRadius:'12px'}}>
            {/* Header */}
            <div className="flex justify-between items-center px-6 py-4 border-b border-gray-200" style={{background:'#fafafa'}}>
              <div className="flex items-center gap-3">
                <div className="p-1.5 rounded-md" style={{background:'rgba(1,128,217,0.1)'}}>
                  <FileText size={20} style={{color:'#0180d9'}} />
                </div>
                <h2 className="font-bold text-base text-gray-900">{docTitle}</h2>
              </div>
              <div className="flex items-center gap-1">
                <button onClick={() => setShowTOC(true)} className="p-2 rounded-lg hover:bg-gray-100 transition" title="Table of Contents"><List size={18} className="text-gray-400" /></button>
                <button onClick={handlePrint} className="p-2 rounded-lg hover:bg-gray-100 transition" title="Print"><Printer size={18} className="text-gray-400" /></button>
                <button onClick={onClose} className="p-2 rounded-lg hover:bg-gray-100 transition"><X size={20} className="text-gray-400" /></button>
              </div>
            </div>

            {/* Search */}
            <div className="px-6 py-3 border-b border-gray-200 bg-white">
              <div className="flex gap-2">
                <div className="flex-1 relative">
                  <input value={docSearch} onChange={e => setDocSearch(e.target.value)} placeholder="Search within document..."
                    className="w-full bg-gray-50 border border-gray-200 pl-10 pr-3 py-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-sm text-gray-900"
                    style={{borderRadius:'8px'}}
                    aria-label="Search document text" />
                  <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                </div>
                {docSearch && <button onClick={() => setDocSearch('')} className="px-4 py-2 rounded-lg bg-gray-50 border border-gray-200 font-semibold text-sm text-gray-600 hover:bg-gray-100 transition" style={{borderRadius:'8px'}}>Clear</button>}
              </div>
            </div>

            {/* Content — renders Google Docs HTML with original formatting */}
            <div className="flex-1 overflow-y-auto p-4 sm:p-6 bg-gray-50 fw-scroll">
              <div ref={contentRef}
                className="gdoc-content bg-white p-6 sm:p-8 shadow-sm border border-gray-200 text-sm leading-relaxed"
                style={{borderRadius:'12px'}}
                dangerouslySetInnerHTML={{ __html: agreementText }} />
            </div>

            {/* Footer */}
            <div className="px-6 py-3 border-t border-gray-200 flex justify-between items-center bg-white">
              <p className="text-xs text-gray-400">Informational only &mdash; the signed agreement controls.</p>
              <button onClick={onClose} className="fw-btn px-5 py-2 text-white rounded-lg font-semibold text-sm transition"
                style={{background:'#0180d9', borderRadius:'8px'}}
                onMouseOver={e => e.currentTarget.style.background='#006bb3'}
                onMouseOut={e => e.currentTarget.style.background='#0180d9'}>
                Close
              </button>
            </div>
          </div>

          {showTOC && <TOCPanel toc={toc} onSelect={() => {}} onClose={() => setShowTOC(false)} />}
        </div>
      );
    }

    // ─── Analytics Dashboard ───────────────────────────────────────
    function AnalyticsDashboard({ onClose }) {
      const events = JSON.parse(localStorage.getItem('fw_analytics') || '[]');
      const views = events.filter(e => e.event === 'page_view').length;
      const searches = events.filter(e => e.event === 'search').length;
      const aiQueries = events.filter(e => e.event === 'ai_query').length;
      const sessions = new Set(events.map(e => e.sessionId)).size;

      const searchTerms = events.filter(e => e.event === 'search').map(e => e.query).filter(Boolean);
      const termCounts = {};
      searchTerms.forEach(t => { termCounts[t] = (termCounts[t] || 0) + 1; });
      const topSearches = Object.entries(termCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

      return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in" role="dialog" aria-label="Analytics dashboard">
          <div className="rounded-xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto animate-scale-in fw-scroll" style={{background:'#0a0a0a', border:'1px solid #222', borderRadius:'12px'}}>
            <div className="p-6 border-b flex justify-between items-center" style={{borderColor:'#222'}}>
              <div className="flex items-center gap-3">
                <BarChart size={22} style={{color:'#0180d9'}} />
                <h2 className="font-bold text-lg text-white">Analytics Dashboard</h2>
              </div>
              <button onClick={onClose} className="p-2 rounded-lg hover:bg-gray-800"><X size={20} className="text-gray-500" /></button>
            </div>

            <div className="p-6 space-y-6">
              {/* Metric Cards */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {[
                  { label: 'Page Views', value: views, color: '#0180d9' },
                  { label: 'Searches', value: searches, color: '#81c31c' },
                  { label: 'AI Queries', value: aiQueries, color: '#a7e3f5' },
                  { label: 'Sessions', value: sessions, color: '#0180d9' },
                ].map(m => (
                  <div key={m.label} className="rounded-lg p-4 text-center" style={{background:'rgba(255,255,255,0.03)', border:'1px solid #222', borderRadius:'8px'}}>
                    <p className="text-2xl font-bold" style={{color:m.color}}>{m.value}</p>
                    <p className="text-xs text-gray-500 mt-1">{m.label}</p>
                  </div>
                ))}
              </div>

              {/* Top Searches */}
              <div>
                <h3 className="font-semibold text-sm mb-3 text-white">Popular Searches</h3>
                {topSearches.length === 0 ? (
                  <p className="text-sm text-gray-600">No searches recorded yet.</p>
                ) : (
                  <div className="space-y-2">
                    {topSearches.map(([term, count]) => (
                      <div key={term} className="flex justify-between items-center rounded-lg px-4 py-2" style={{background:'rgba(255,255,255,0.03)', border:'1px solid #1a1a1a'}}>
                        <span className="text-sm text-gray-300">{term}</span>
                        <span className="text-xs font-mono text-gray-600">{count}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ─── PIN Gate Component (Mobile-Friendly Keypad) ─────────────
    function PinGate({ clientType, onSuccess, onCancel }) {
      const [pin, setPin] = useState(['', '', '', '']);
      const [error, setError] = useState('');
      const [shake, setShake] = useState(false);
      const inputRefs = [useRef(null), useRef(null), useRef(null), useRef(null)];
      const config = CLIENT_TYPES[clientType];

      useEffect(() => {
        inputRefs[0].current?.focus();
      }, []);

      const handleDigit = (digit) => {
        const idx = pin.findIndex(d => d === '');
        if (idx === -1) return;
        const newPin = [...pin];
        newPin[idx] = digit;
        setPin(newPin);
        setError('');

        if (idx === 3) {
          // All 4 digits entered - verify
          const entered = newPin.join('');
          const correct = ACCESS_PINS[clientType] || '0000';
          if (entered === correct) {
            sessionStorage.setItem(`fw_auth_${clientType}`, 'true');
            onSuccess();
          } else {
            setShake(true);
            setError('Invalid access code');
            setTimeout(() => { setPin(['', '', '', '']); setShake(false); }, 600);
          }
        } else {
          inputRefs[idx + 1]?.current?.focus();
        }
      };

      const handleBackspace = () => {
        const idx = pin.findLastIndex(d => d !== '');
        if (idx === -1) return;
        const newPin = [...pin];
        newPin[idx] = '';
        setPin(newPin);
        inputRefs[idx]?.current?.focus();
      };

      const handleKeyDown = (e, idx) => {
        if (e.key === 'Backspace') { e.preventDefault(); handleBackspace(); }
        if (/^\d$/.test(e.key)) { e.preventDefault(); handleDigit(e.key); }
        if (e.key === 'Escape') onCancel();
      };

      return (
        <div className="fixed inset-0 bg-black z-50 flex items-center justify-center p-6 animate-fade-in">
          <div className="max-w-sm w-full text-center space-y-6">
            {/* Header */}
            <div>
              <Lock className="mx-auto mb-3" size={28} style={{color:'#0180d9'}} />
              <h2 className="text-xl font-semibold text-white">{config.label} Portal</h2>
              <p className="text-gray-500 text-sm mt-1">Enter your access code</p>
            </div>

            {/* PIN Display */}
            <div className={`flex justify-center gap-3 ${shake ? 'animate-[shake_0.5s_ease-in-out]' : ''}`}>
              {pin.map((digit, i) => (
                <div key={i} className="relative">
                  <input
                    ref={inputRefs[i]}
                    type="text"
                    inputMode="numeric"
                    maxLength={1}
                    value={digit}
                    readOnly
                    onKeyDown={(e) => handleKeyDown(e, i)}
                    className={`w-14 h-16 text-center text-2xl font-bold rounded-lg border-2 bg-black text-white outline-none transition-all ${
                      digit ? 'border-blue-500' : 'border-gray-700'
                    } focus:border-blue-400`}
                    style={{borderRadius:'8px'}}
                    aria-label={`PIN digit ${i + 1}`}
                  />
                  {digit && <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div className="w-3 h-3 rounded-full" style={{background:'#0180d9'}} />
                  </div>}
                </div>
              ))}
            </div>

            {error && <p className="text-red-400 text-sm font-medium">{error}</p>}

            {/* Numpad */}
            <div className="grid grid-cols-3 gap-2 max-w-[240px] mx-auto">
              {[1,2,3,4,5,6,7,8,9].map(n => (
                <button key={n} onClick={() => handleDigit(String(n))}
                  className="h-14 rounded-lg bg-gray-900 hover:bg-gray-800 active:bg-gray-700 text-white text-xl font-bold transition-colors border border-gray-700"
                  style={{borderRadius:'8px'}}>
                  {n}
                </button>
              ))}
              <button onClick={onCancel}
                className="h-14 rounded-lg bg-gray-900/50 hover:bg-gray-800 text-gray-500 text-sm font-semibold transition border border-gray-800"
                style={{borderRadius:'8px'}}>
                Back
              </button>
              <button onClick={() => handleDigit('0')}
                className="h-14 rounded-lg bg-gray-900 hover:bg-gray-800 active:bg-gray-700 text-white text-xl font-bold transition-colors border border-gray-700"
                style={{borderRadius:'8px'}}>
                0
              </button>
              <button onClick={handleBackspace}
                className="h-14 rounded-lg bg-gray-900/50 hover:bg-gray-800 text-gray-500 text-lg transition border border-gray-800 flex items-center justify-center"
                style={{borderRadius:'8px'}}>
                <X size={20} />
              </button>
            </div>

            <p className="text-xs text-gray-600">4-digit client access code</p>
          </div>

          <style>{`
            @keyframes shake {
              0%, 100% { transform: translateX(0); }
              10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
              20%, 40%, 60%, 80% { transform: translateX(4px); }
            }
          `}</style>
        </div>
      );
    }

    // ─── Compliance Packet Component (Municipal) ───────────────────
    function CompliancePacket() {
      return (
        <div className="fw-card p-6 animate-slide-up">
          <div className="flex items-center gap-3 mb-4">
            <div className="p-2 rounded-lg" style={{background:'rgba(1,128,217,0.1)', border:'1px solid rgba(1,128,217,0.2)'}}>
              <Download size={20} style={{color:'#0180d9'}} />
            </div>
            <div>
              <h3 className="font-bold text-white text-sm">Compliance Packet</h3>
              <p className="text-xs text-gray-500">One-click download for city clerks</p>
            </div>
          </div>
          <div className="space-y-2">
            {COMPLIANCE_PACKET.map((item, i) => (
              <a key={i}
                href={item.url || '#'}
                target="_blank" rel="noopener noreferrer"
                className={`flex items-center justify-between p-3 rounded-lg border transition-all ${
                  item.url
                    ? 'border-gray-800 hover:border-blue-500 cursor-pointer'
                    : 'border-dashed border-gray-800 opacity-40 cursor-not-allowed'
                }`}
                style={{borderRadius:'8px'}}>
                <div className="flex items-center gap-3">
                  <FileText size={16} style={{color:'#0180d9', opacity:0.7}} />
                  <span className="text-sm font-medium text-gray-300">{item.name}</span>
                </div>
                {item.url ? (
                  <Download size={16} style={{color:'#0180d9'}} />
                ) : (
                  <span className="text-[10px] text-gray-600 px-2 py-0.5 rounded-full" style={{background:'rgba(255,255,255,0.05)'}}>Coming</span>
                )}
              </a>
            ))}
          </div>
        </div>
      );
    }

    // ─── Main App ──────────────────────────────────────────────────
    function App() {
      const [view, setView] = useState(() => sessionStorage.getItem('fw_view') || 'landing');
      const [tab, setTab] = useState(() => sessionStorage.getItem('fw_tab') || 'dashboard');
      const [clientType, setClientType] = useState(() => sessionStorage.getItem('fw_client_type') || null);
      const [pendingType, setPendingType] = useState(null); // type waiting for PIN
      const [showPinGate, setShowPinGate] = useState(false);
      const [mode, setMode] = useState('quick');
      const [isTyping, setIsTyping] = useState(false);
      const [docTexts, setDocTexts] = useState({}); // { docId: text }
      const [docStatuses, setDocStatuses] = useState({}); // { docId: 'loading'|'loaded'|'cached'|'error'|'no-id' }
      const [activeDocId, setActiveDocId] = useState(null); // which doc is open in viewer
      const [chatInput, setChatInput] = useState('');
      const [chatHistory, setChatHistory] = useState([
        { role: 'ai', text: 'Welcome to the Freshwater Vault. Ask about your agreement terms and I\'ll show the exact clause. (Informational only \u2014 the signed agreement controls.)' }
      ]);
      const [showDocViewer, setShowDocViewer] = useState(false);
      const [showShortcuts, setShowShortcuts] = useState(false);
      const [showAnalytics, setShowAnalytics] = useState(false);
      const [mobileMenu, setMobileMenu] = useState(false);

      const chatEndRef = useRef(null);
      const chatInputRef = useRef(null);

      // Persist state
      useEffect(() => { sessionStorage.setItem('fw_view', view); }, [view]);
      useEffect(() => { sessionStorage.setItem('fw_tab', tab); }, [tab]);
      useEffect(() => { if (clientType) sessionStorage.setItem('fw_client_type', clientType); }, [clientType]);

      // SEO: Add noindex for gated pages
      useEffect(() => {
        let meta = document.querySelector('meta[name="robots"]');
        if (clientType && clientType !== 'residential') {
          if (!meta) { meta = document.createElement('meta'); meta.name = 'robots'; document.head.appendChild(meta); }
          meta.content = 'noindex, nofollow';
        } else if (meta) {
          meta.remove();
        }
      }, [clientType]);

      // Handler: client type selection from landing page
      const handleClientSelect = (type) => {
        const config = CLIENT_TYPES[type];
        if (!config) return;
        if (config.gated) {
          // Check if already authenticated this session
          if (sessionStorage.getItem(`fw_auth_${type}`) === 'true') {
            setClientType(type);
            setView('dashboard');
          } else {
            setPendingType(type);
            setShowPinGate(true);
          }
        } else {
          setClientType(type);
          setView('dashboard');
        }
      };

      const handlePinSuccess = () => {
        setShowPinGate(false);
        setClientType(pendingType);
        setPendingType(null);
        setView('dashboard');
        showToast(`Welcome to the ${CLIENT_TYPES[pendingType]?.label} Portal`, 'success');
      };

      // Analytics init
      useEffect(() => { analytics.init(); }, []);

      // Load documents for current client type
      useEffect(() => {
        if (!clientType) return;

        const visibleDocs = Object.values(DOCUMENTS).filter(d => d.audience.includes(clientType));

        visibleDocs.forEach(async (doc) => {
          if (!doc.googleDocId) {
            setDocStatuses(prev => ({ ...prev, [doc.id]: 'no-id' }));
            setDocTexts(prev => ({ ...prev, [doc.id]: 'Document coming soon. Contact Freshwater for details.' }));
            return;
          }

          const cacheKey = `fw_doc_${doc.id}`;
          const cacheTimeKey = `fw_doc_time_${doc.id}`;
          const cached = localStorage.getItem(cacheKey);
          const cachedTime = localStorage.getItem(cacheTimeKey);

          if (cached && cachedTime && (Date.now() - parseInt(cachedTime)) < CACHE_DURATION) {
            setDocTexts(prev => ({ ...prev, [doc.id]: cached }));
            setDocStatuses(prev => ({ ...prev, [doc.id]: 'cached' }));
            return;
          }

          setDocStatuses(prev => ({ ...prev, [doc.id]: 'loading' }));

          try {
            const response = await fetch(`https://docs.google.com/document/d/${doc.googleDocId}/export?format=html`);
            if (!response.ok) throw new Error('Fetch failed');
            const rawHtml = await response.text();
            // Extract Google's CSS from <head> (contains highlight colors, table styles, etc.)
            const styleMatches = rawHtml.match(/<style[^>]*>([\s\S]*?)<\/style>/gi);
            const googleStyles = styleMatches ? styleMatches.join('\n') : '';
            // Extract the <body> content
            const bodyMatch = rawHtml.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
            const bodyContent = bodyMatch ? bodyMatch[1] : rawHtml;
            // Combine: styles first, then body HTML (preserves highlights, tables, formatting)
            let text = googleStyles + bodyContent;
            setDocTexts(prev => ({ ...prev, [doc.id]: text }));
            setDocStatuses(prev => ({ ...prev, [doc.id]: 'loaded' }));
            localStorage.setItem(cacheKey, text);
            localStorage.setItem(cacheTimeKey, Date.now().toString());
          } catch (err) {
            if (cached) {
              setDocTexts(prev => ({ ...prev, [doc.id]: cached }));
              setDocStatuses(prev => ({ ...prev, [doc.id]: 'cached' }));
            } else {
              setDocTexts(prev => ({ ...prev, [doc.id]: 'Unable to load document. Please contact support.' }));
              setDocStatuses(prev => ({ ...prev, [doc.id]: 'error' }));
            }
          }
        });
      }, [clientType]);

      // Combined HTML for document viewer, plain text for AI search
      const stripHtml = (html) => html.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
      const agreementText = useMemo(() => Object.values(docTexts).join('\n\n---\n\n'), [docTexts]);
      const agreementPlainText = useMemo(() => stripHtml(agreementText), [agreementText]);
      const agreementStatus = useMemo(() => {
        const statuses = Object.values(docStatuses);
        if (statuses.length === 0) return 'loading';
        if (statuses.every(s => s === 'loaded')) return 'loaded';
        if (statuses.some(s => s === 'loaded' || s === 'cached')) return 'cached';
        if (statuses.some(s => s === 'loading')) return 'loading';
        return 'error';
      }, [docStatuses]);

      // Get documents visible to current client type
      const visibleDocs = useMemo(() => {
        if (!clientType) return [];
        return Object.values(DOCUMENTS).filter(d => d.audience.includes(clientType));
      }, [clientType]);

      // Check URL params for client type
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const type = params.get('type');
        if (type === 'residential' || type === 'commercial') {
          setClientType(type);
          setView('dashboard');
        }
      }, []);

      // Scroll chat
      useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [chatHistory, isTyping]);

      // Keyboard shortcuts
      useEffect(() => {
        const handler = (e) => {
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            if (e.key === 'Escape') { e.target.blur(); return; }
            return;
          }
          if (e.key === '/') { e.preventDefault(); chatInputRef.current?.focus(); }
          if (e.key === 'Escape') {
            setShowDocViewer(false); setShowShortcuts(false);
            setShowAnalytics(false); setMobileMenu(false);
          }
          if (e.key === '1') { setView('dashboard'); setTab('dashboard'); }
          if (e.key === '2') { setView('dashboard'); setTab('chat'); }
          if (e.key === '?') setShowShortcuts(true);
        };
        window.addEventListener('keydown', handler);
        return () => window.removeEventListener('keydown', handler);
      }, []);

      // Check for admin access
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('key') === 'SECRET') setShowAnalytics(true);
      }, []);

      // Register service worker
      useEffect(() => {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('sw.js').catch(() => {});
        }
      }, []);

      // clientDocs is now derived from visibleDocs + docStatuses

      const pushMsg = (role, text) => setChatHistory(prev => [...prev, { role, text }]);

      const handleChat = async () => {
        const q = chatInput.trim();
        if (!q) return;
        pushMsg('user', q);
        setChatInput('');
        setIsTyping(true);

        analytics.track('search', { query: q, mode });

        const hits = bestMatches(agreementPlainText, q, 3);
        if (!hits.length) {
          pushMsg('ai', "I couldn't locate that in the agreement text. Try keywords like: cancellation, late fee, liability, arbitration, scope, snow, mowing.");
          setIsTyping(false);
          return;
        }

        if (mode === 'quick') {
          const best = hits[0];
          pushMsg('ai', `Here you go.\n\nSOURCE: ${best.heading}\n\n"${excerpt(best.text)}"\n\n(Informational only \u2014 the signed agreement controls.)`);
          setIsTyping(false);
          return;
        }

        // AI Explain mode
        analytics.track('ai_query', { query: q });
        try {
          const response = await fetch('/.netlify/functions/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              question: q,
              excerpts: hits.map(h => ({ heading: h.heading, text: excerpt(h.text, 1200) })),
            }),
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.error || 'AI unavailable');
          pushMsg('ai', data.answer);
        } catch (e) {
          pushMsg('ai', 'AI Explain is unavailable right now. Use Quick mode or contact Freshwater support.');
          showToast('AI Explain unavailable', 'error');
        } finally {
          setIsTyping(false);
        }
      };

      // ─── Landing View ───────────────────────────────────────────
      if (view === 'landing') {
        return (
          <div className="min-h-screen bg-black flex flex-col items-center justify-center p-6 text-white">

            <div className="max-w-md w-full space-y-10 text-center animate-fade-in">
              {/* Logo */}
              <div className="flex justify-center">
                <img src="public/assets/logo-dark.png" alt="Freshwater Landscaping" className="h-16 sm:h-20" style={{filter:'drop-shadow(0 0 30px rgba(1,128,217,0.12))'}} />
              </div>

              <div className="relative">
                <div className="absolute inset-x-0 top-0 h-px" style={{background:'linear-gradient(90deg, transparent, #0180d9 30%, #0180d9 70%, transparent)'}} />
                <h1 className="text-lg font-semibold py-4 tracking-widest uppercase" style={{color:'#a7e3f5', letterSpacing:'0.2em'}}>
                  Client Portal
                </h1>
                <div className="absolute inset-x-0 bottom-0 h-px" style={{background:'linear-gradient(90deg, transparent, #0180d9 30%, #0180d9 70%, transparent)'}} />
              </div>

              {/* Portal Selection */}
              <div className="space-y-4">
                <p className="text-sm text-gray-500">Select your portal to access service agreements.</p>

                <div className="space-y-2">
                  {[
                    { type: 'residential', label: 'Residential', sub: 'View your service documents', locked: false },
                    { type: 'commercial', label: 'Commercial', sub: 'Access code required', locked: true },
                    { type: 'hoa', label: 'HOA / Townhomes', sub: 'Access code required', locked: true },
                    { type: 'municipal', label: 'Municipal / City', sub: 'Access code required', locked: true },
                  ].map(item => (
                    <button key={item.type} onClick={() => handleClientSelect(item.type)}
                      className="fw-card fw-btn w-full text-left px-5 py-4 flex items-center justify-between group">
                      <div>
                        <span className="font-semibold text-white block text-sm">{item.label}</span>
                        <span className="text-xs text-gray-500 flex items-center gap-1 mt-0.5">
                          {item.locked && <Lock size={10} className="text-gray-600" />} {item.sub}
                        </span>
                      </div>
                      <ChevronRight size={16} className="text-gray-600 group-hover:text-blue-400 transition-colors" />
                    </button>
                  ))}
                </div>
              </div>

              {/* Contact */}
              <div className="pt-2 space-y-2 text-sm text-gray-500">
                <p>
                  <a href="tel:6129998067" className="hover:text-white transition font-medium" style={{color:'#81c31c'}}>(612) 999-8067</a>
                </p>
                <p className="text-[11px] text-gray-700">&copy; 2024&ndash;2026 Freshwater Landscaping LLC</p>
              </div>
            </div>

            {/* PIN Gate Overlay */}
            {showPinGate && (
              <PinGate
                clientType={pendingType}
                onSuccess={handlePinSuccess}
                onCancel={() => { setShowPinGate(false); setPendingType(null); }}
              />
            )}
          </div>
        );
      }

      // ─── Dashboard View ──────────────────────────────────────────
      return (
        <div className="min-h-screen bg-black text-white">
          {/* Navigation */}
          <nav className="bg-black sticky top-0 z-40" style={{borderBottom:'1px solid #1a1a1a'}} role="navigation" aria-label="Main navigation">
            <div className="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
              <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('landing')}>
                <img src="public/assets/logo-dark.png" alt="Freshwater Landscaping" className="h-8 sm:h-10" />
              </div>

              {/* Desktop nav */}
              <div className="hidden sm:flex items-center gap-1 p-1 rounded-lg" style={{background:'rgba(255,255,255,0.03)', border:'1px solid #1a1a1a'}}>
                <button onClick={() => setTab('dashboard')}
                  className={`px-4 py-1.5 rounded-md font-semibold text-sm transition ${tab === 'dashboard' ? 'text-white' : 'text-gray-500 hover:text-gray-300'}`}
                  style={tab === 'dashboard' ? {background:'rgba(1,128,217,0.15)', color:'#a7e3f5'} : {}}>
                  Documents
                </button>
                <button onClick={() => setTab('chat')}
                  className={`px-4 py-1.5 rounded-md font-semibold text-sm transition flex items-center gap-2 ${tab === 'chat' ? 'text-white' : 'text-gray-500 hover:text-gray-300'}`}
                  style={tab === 'chat' ? {background:'rgba(1,128,217,0.15)', color:'#a7e3f5'} : {}}>
                  <MessageSquare size={14} /> Ask
                </button>
              </div>

              {/* Mobile menu button */}
              <button onClick={() => setMobileMenu(p => !p)} className="sm:hidden p-2 rounded-lg hover:bg-gray-900 text-gray-400" aria-label="Toggle menu">
                <Menu size={22} />
              </button>
            </div>

            {/* Mobile menu */}
            {mobileMenu && (
              <div className="sm:hidden border-t border-gray-800 p-3 space-y-1 bg-black">
                <button onClick={() => { setTab('dashboard'); setMobileMenu(false); }} className="w-full text-left px-4 py-3 rounded-lg text-sm font-semibold text-gray-300 hover:bg-gray-900">Documents</button>
                <button onClick={() => { setTab('chat'); setMobileMenu(false); }} className="w-full text-left px-4 py-3 rounded-lg text-sm font-semibold text-gray-300 hover:bg-gray-900 flex items-center gap-2"><MessageSquare size={16} /> Ask</button>
              </div>
            )}
          </nav>

          <main className="max-w-5xl mx-auto p-4 sm:p-6">
            {tab === 'dashboard' ? (
              <div className="space-y-8 animate-fade-in">
                {/* Hero Banner - Dynamic per client type */}
                {(() => {
                  const ct = CLIENT_TYPES[clientType] || CLIENT_TYPES.residential;
                  return (
                    <div className="fw-hero border rounded-lg p-6 sm:p-8" style={{borderColor:'#1a1a1a', background:'rgba(10,10,10,0.95)', borderRadius:'12px'}}>
                      <div className="flex items-start justify-between">
                        <div>
                          <p className="text-xs font-semibold uppercase mb-1" style={{color:'#0180d9', letterSpacing:'0.15em'}}>{ct.tagline}</p>
                          <h2 className="text-xl sm:text-2xl font-bold text-white mt-1">{ct.welcome}</h2>
                        </div>
                        <button onClick={() => { setClientType(null); setView('landing'); }}
                          className="fw-btn text-xs border border-gray-700 hover:border-gray-400 px-3 py-1.5 rounded-lg transition font-medium shrink-0 ml-4 text-gray-500 hover:text-white"
                          style={{borderRadius:'8px'}}>
                          Switch Portal
                        </button>
                      </div>
                      <div className="flex flex-wrap items-center gap-3 mt-4 text-sm text-gray-500">
                        <span>{ct.label} Portal</span>
                        <span className="w-1 h-1 rounded-full bg-gray-700" />
                        <span>{visibleDocs.length} document{visibleDocs.length !== 1 ? 's' : ''} available</span>
                      </div>
                    </div>
                  );
                })()}

                {/* Document Cards */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {visibleDocs.map((doc) => {
                    const status = docStatuses[doc.id] || 'loading';
                    const hasContent = status === 'loaded' || status === 'cached';
                    const isComingSoon = status === 'no-id';

                    return (
                      <div key={doc.id}
                        onClick={() => { if (!isComingSoon) { setActiveDocId(doc.id); setShowDocViewer(true); } }}
                        className={`fw-card fw-btn p-5 ${isComingSoon ? 'opacity-40 cursor-default' : 'cursor-pointer'}`}
                        role="button" tabIndex={0} aria-label={`View ${doc.title}`}
                        onKeyDown={e => e.key === 'Enter' && !isComingSoon && (() => { setActiveDocId(doc.id); setShowDocViewer(true); })()}>
                        <div className="flex items-center justify-between">
                          <div>
                            <h3 className="font-semibold text-white text-sm mb-1">{doc.title}</h3>
                            <p className="text-xs text-gray-500">{doc.type} &middot; {doc.season}</p>
                          </div>
                          <div className="flex items-center gap-3">
                            {isComingSoon ? (
                              <span className="text-[11px] text-gray-600 uppercase tracking-wide">Coming Soon</span>
                            ) : hasContent ? (
                              <span className="text-xs flex items-center" style={{color:'#81c31c'}}><span className="fw-status-dot" />Ready</span>
                            ) : status === 'loading' ? (
                              <span className="text-xs text-gray-500">Loading...</span>
                            ) : (
                              <span className="text-xs text-red-400">Error</span>
                            )}
                            {!isComingSoon && <ChevronRight size={16} className="text-gray-600" />}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>

                {/* Compliance Packet - Municipal only */}
                {clientType === 'municipal' && <CompliancePacket />}

                {/* Clause Finder CTA */}
                <div className="fw-card p-6">
                  <div className="flex items-start gap-4">
                    <div className="p-2.5 rounded-lg flex-shrink-0" style={{background:'rgba(1,128,217,0.1)', border:'1px solid rgba(1,128,217,0.2)'}}>
                      <Search size={20} style={{color:'#0180d9'}} />
                    </div>
                    <div className="flex-1">
                      <h3 className="font-semibold text-sm mb-1" style={{color:'#a7e3f5'}}>Have a question about your agreement?</h3>
                      <p className="text-sm text-gray-500 mb-4">
                        Search for specific clauses or terms across your documents.
                      </p>
                      <button onClick={() => setTab('chat')}
                        className="fw-btn text-white px-5 py-2.5 rounded-lg font-semibold text-sm flex items-center gap-2"
                        style={{background:'#0180d9', borderRadius:'8px'}}
                        onMouseOver={e => e.currentTarget.style.background='#006bb3'}
                        onMouseOut={e => e.currentTarget.style.background='#0180d9'}>
                        Open Search <ArrowRight size={16} />
                      </button>
                    </div>
                  </div>
                </div>

                {/* Contact */}
                <div className="flex flex-col sm:flex-row items-center justify-between p-5 rounded-lg border border-gray-800/50" style={{borderRadius:'12px', background:'rgba(10,10,10,0.5)'}}>
                  <div className="text-sm text-gray-500 mb-3 sm:mb-0">Need help? Contact Freshwater Landscaping</div>
                  <div className="flex items-center gap-4">
                    <a href="tel:6129998067" className="text-sm font-semibold hover:text-white transition" style={{color:'#81c31c'}}>(612) 999-8067</a>
                    <span className="w-1 h-1 rounded-full bg-gray-700" />
                    <a href="mailto:freshwaterlandscaping@gmail.com" className="text-sm hover:text-white transition" style={{color:'#a7e3f5'}}>freshwaterlandscaping@gmail.com</a>
                  </div>
                </div>

                {/* Footer */}
                <div className="text-center space-y-1 pb-4">
                  <p className="text-[11px] text-gray-600">Informational only &mdash; the signed agreement controls.</p>
                  <p className="text-[11px] text-gray-700">&copy; 2024&ndash;2026 Freshwater Landscaping LLC</p>
                </div>
              </div>
            ) : (
              /* ─── Chat Tab ─────────────────────────────────── */
              <div className="fw-card h-[76vh] flex flex-col overflow-hidden animate-fade-in">
                {/* Chat Header */}
                <div className="p-4 border-b border-gray-800 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                  <div className="flex items-center gap-3">
                    <div className="p-2 rounded-lg" style={{background:'rgba(1,128,217,0.15)', border:'1px solid rgba(1,128,217,0.25)'}}>
                      <Search size={18} style={{color:'#0180d9'}} />
                    </div>
                    <div>
                      <h3 className="font-semibold text-sm text-white">Document Search</h3>
                      <p className="text-xs text-gray-500">Find clauses and terms (informational only)</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-1 p-1 rounded-lg" style={{background:'rgba(255,255,255,0.05)', border:'1px solid #222'}}>
                    <button onClick={() => setMode('quick')}
                      className={`px-3 py-1.5 rounded-md text-xs font-semibold transition ${mode === 'quick' ? 'text-white' : 'text-gray-500 hover:text-gray-300'}`}
                      style={mode === 'quick' ? {background:'#0180d9'} : {}}
                      title="Free: local clause search">
                      Quick
                    </button>
                    <button onClick={() => setMode('ai')}
                      className={`px-3 py-1.5 rounded-md text-xs font-semibold transition ${mode === 'ai' ? 'text-white' : 'text-gray-500 hover:text-gray-300'}`}
                      style={mode === 'ai' ? {background:'#0180d9'} : {}}
                      title="Uses protected server key">
                      AI Explain
                    </button>
                  </div>
                </div>

                {/* Chat Messages */}
                <div className="flex-1 overflow-y-auto p-4 sm:p-6 space-y-4 no-scrollbar" role="log" aria-label="Chat messages">
                  {chatHistory.map((msg, i) => (
                    <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} animate-slide-up`}>
                      <div className={`max-w-[88%] sm:max-w-[80%] p-4 rounded-2xl text-sm whitespace-pre-wrap leading-relaxed ${
                        msg.role === 'user'
                          ? 'text-white rounded-tr-sm'
                          : 'text-gray-200 rounded-tl-sm'
                      }`}
                      style={msg.role === 'user'
                        ? {background:'#0180d9'}
                        : {background:'rgba(255,255,255,0.06)', border:'1px solid #222'}
                      }>
                        {msg.text}
                      </div>
                    </div>
                  ))}
                  {isTyping && (
                    <div className="flex justify-start">
                      <div className="px-4 py-3 rounded-2xl rounded-tl-sm flex items-center gap-2" style={{background:'rgba(255,255,255,0.06)', border:'1px solid #222'}}>
                        <div className="flex gap-1">
                          <span className="w-2 h-2 rounded-full animate-bounce" style={{background:'#0180d9', animationDelay:'0ms'}} />
                          <span className="w-2 h-2 rounded-full animate-bounce" style={{background:'#0180d9', animationDelay:'150ms'}} />
                          <span className="w-2 h-2 rounded-full animate-bounce" style={{background:'#0180d9', animationDelay:'300ms'}} />
                        </div>
                        <span className="text-xs text-gray-500 ml-1">Analyzing agreement...</span>
                      </div>
                    </div>
                  )}
                  <div ref={chatEndRef} />
                </div>

                {/* Chat Input */}
                <div className="p-4 border-t border-gray-800">
                  <div className="flex gap-2">
                    <input ref={chatInputRef} type="text" value={chatInput}
                      onChange={e => setChatInput(e.target.value)}
                      onKeyDown={e => e.key === 'Enter' && handleChat()}
                      placeholder='Example: "If I cancel mid-season, what do I owe?"'
                      className="flex-1 p-3 rounded-lg outline-none text-sm text-white placeholder-gray-600 transition"
                      style={{background:'rgba(255,255,255,0.05)', border:'1px solid #222'}}
                      onFocus={e => e.target.style.borderColor='#0180d9'}
                      onBlur={e => e.target.style.borderColor='#222'}
                      aria-label="Type your question about the agreement" />
                    <button onClick={handleChat}
                      className="fw-btn text-white p-3 rounded-lg disabled:opacity-50"
                      style={{background:'#0180d9', borderRadius:'8px'}}
                      onMouseOver={e => { if (!isTyping) e.currentTarget.style.background='#006bb3'; }}
                      onMouseOut={e => e.currentTarget.style.background='#0180d9'}
                      disabled={isTyping} title="Ask" aria-label="Send question">
                      <Send size={18} />
                    </button>
                  </div>
                  <div className="flex justify-between items-center mt-2">
                    <span className="text-[11px] text-gray-600">
                      <span className="font-medium text-gray-500">Note:</span> Quick mode is free. AI Explain uses a server function.
                    </span>
                    <kbd className="text-[10px] text-gray-600 px-1.5 py-0.5 rounded font-mono" style={{background:'rgba(255,255,255,0.05)', border:'1px solid #222'}}>/</kbd>
                  </div>
                </div>
              </div>
            )}
          </main>

          {/* Modals */}
          {showDocViewer && <DocViewer
            agreementText={activeDocId ? (docTexts[activeDocId] || 'Loading...') : agreementText}
            docTitle={activeDocId ? (DOCUMENTS[activeDocId]?.title || 'Document') : 'Agreement'}
            onClose={() => { setShowDocViewer(false); setActiveDocId(null); }}
          />}
          {showShortcuts && <ShortcutsModal onClose={() => setShowShortcuts(false)} />}
          {showAnalytics && <AnalyticsDashboard onClose={() => setShowAnalytics(false)} />}
        </div>
      );
    }

    // ─── Mount ─────────────────────────────────────────────────────
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>
    );
  </script>
</body>
</html>
